<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta Pro - Orden Inteligente</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; --warning: #f59e0b; --muted: #64748b; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        .seccion { display: none; padding: 20px; }
        .activa { display: block; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #ddd; z-index: 100; }
        .nav-item { cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #666; text-align: center; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .card b { display: block; font-size: 1.4rem; margin-top: 5px; }
        table { width: 100%; background: white; border-radius: 10px; border-collapse: collapse; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .pagado { background: #f0fdf4; }
        .badge-pagado { color: var(--success); font-size: 0.6rem; border: 1px solid var(--success); padding: 2px 4px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .pos-num { background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-right: 8px; font-weight: bold; }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-opt { width: 100%; padding: 15px; margin-bottom: 10px; border-radius: 10px; border: none; font-weight: bold; color: white; cursor: pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 85%; max-width: 400px; border-radius: 15px; box-sizing: border-box; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
    </style>
</head>
<body>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/851m8ra8nv7bu"; 
        let datosGlobales = [];
        let clienteSel = null;
        const fechaHoy = () => new Date().toLocaleDateString();
    </script>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navegar('inicio', this)"><br>Inicio</div>
        <div class="nav-item" onclick="navegar('resumen', this)"><br>Caja</div>
        <div class="nav-item" onclick="navegar('clientes', this)"><br>Lista</div>
    </div>

    <div id="inicio" class="seccion activa">
        <h2 style="text-align:center">Gesti贸n de Ruta</h2>
        <button class="btn-main" onclick="abrirModal('modalReg')">+ NUEVO PRSTAMO</button>
    </div>

    <div id="resumen" class="seccion">
        <h2>Resumen</h2>
        <div class="card"><span>Cobrado hoy</span><b id="c_hoy">$0</b></div>
        <div class="card"><span>Total en calle</span><b id="t_calle">$0</b></div>
    </div>

    <div id="clientes" class="seccion">
        <h2>Mi Lista</h2>
        <input type="text" id="buscador" placeholder=" Buscar cliente..." onkeyup="filtrar()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;">
        <div id="loading" style="display:none; text-align:center; color:blue; font-weight:bold;">Sincronizando orden...</div>
        <table><tbody id="lista_c"></tbody></table>
    </div>

    <div id="modalReg" class="modal"><div class="modal-content">
        <h3>Nuevo Cliente</h3>
        <input type="text" id="nom" placeholder="Nombre">
        <input type="number" id="mon" placeholder="Monto">
        <input type="number" id="int" placeholder="% Inter茅s">
        <input type="number" id="pos" placeholder="Posici贸n (Ej: 1, 2, 3)">
        <button class="btn-main" onclick="guardar()">GUARDAR</button>
        <button onclick="cerrarModal('modalReg')" style="width:100%; background:none; border:none; color:red; margin-top:10px;">Cerrar</button>
    </div></div>

    <div id="modalMenu" class="modal"><div class="modal-content">
        <h3 id="menu_nombre" style="text-align:center; color:var(--primary);">Cliente</h3>
        <button class="btn-opt" style="background:var(--primary);" onclick="verHis()">Historial</button>
        <button class="btn-opt" style="background:#475569;" onclick="cambiarPos()">Mover de Posici贸n</button>
        <button class="btn-opt" style="background:var(--warning);" onclick="prepararRenovar()">Renovar / Editar</button>
        <button class="btn-opt" style="background:var(--danger);" onclick="eliminarCli()">Eliminar Cliente</button>
        <button onclick="cerrarModal('modalMenu')" style="width:100%; background:none; border:none; color:gray; margin-top:5px;">Volver</button>
    </div></div>

    <div id="modalHis" class="modal"><div class="modal-content">
        <h3 id="his_nombre">Pagos</h3>
        <div id="his_lista" style="max-height:250px; overflow-y:auto;"></div>
        <button class="btn-main" style="margin-top:15px;" onclick="cerrarModal('modalHis')">Cerrar</button>
    </div></div>

    <script>
        function navegar(id, el) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('activa');
            el.classList.add('active');
            if(id !== 'inicio') cargarDatos();
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'block'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }

        async function cargarDatos() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                datosGlobales = Array.isArray(json) ? json : [];
                
                // Ordenar por n煤mero de posici贸n
                datosGlobales.sort((a, b) => (parseInt(a.posicion) || 999) - (parseInt(b.posicion) || 999));
                
                dibujar();
                actualizarBalance();
            } catch (e) { console.error(e); }
            document.getElementById('loading').style.display = 'none';
        }

        function dibujar() {
            const lista = document.getElementById('lista_c');
            lista.innerHTML = "";
            datosGlobales.forEach(d => {
                let s = parseFloat(d.saldo) || 0;
                let pagadoHoy = JSON.parse(d.pagos || "[]").some(p => p.fecha === fechaHoy());
                lista.innerHTML += `<tr class="${pagadoHoy ? 'pagado' : ''}" data-nombre="${d.nombre.toLowerCase()}">
                    <td>
                        <span class="pos-num">${d.posicion || '--'}</span>
                        <b style="color:var(--primary); cursor:pointer;" onclick="abrirMenu('${d.id}')">${d.nombre}</b>
                        ${pagadoHoy ? '<span class="badge-pagado">PAGADO</span>' : ''}
                        <br><small style="margin-left:38px;">Saldo: $${s.toFixed(2)}</small>
                    </td>
                    <td align="right"><button onclick="cobrar('${d.id}')" style="background:${pagadoHoy ? '#94a3b8' : '#16a34a'}; color:white; border:none; padding:12px; border-radius:8px;">$</button></td>
                </tr>`;
            });
        }

        async function cambiarPos() {
            let nPos = parseInt(prompt("Mover a la posici贸n n煤mero:", clienteSel.posicion));
            if(isNaN(nPos)) return;

            document.getElementById('loading').innerText = "Reorganizando lista...";
            document.getElementById('loading').style.display = 'block';

            // L贸gica de empuje: Si alguien tiene la misma pos o superior, sumamos 1
            for (let cli of datosGlobales) {
                if (cli.id === clienteSel.id) {
                    await fetch(`${API_URL}/id/${cli.id}`, {
                        method: 'PATCH',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ posicion: nPos.toString() })
                    });
                } else {
                    let pActual = parseInt(cli.posicion) || 999;
                    if (pActual >= nPos) {
                        await fetch(`${API_URL}/id/${cli.id}`, {
                            method: 'PATCH',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ posicion: (pActual + 1).toString() })
                        });
                    }
                }
            }
            cerrarModal('modalMenu');
            cargarDatos();
        }

        async function guardar() {
            let n = document.getElementById('nom').value, m = parseFloat(document.getElementById('mon').value), 
                i = parseFloat(document.getElementById('int').value) || 0, p = document.getElementById('pos').value || "99";
            if(!n || !m) return alert("Llena los campos");
            
            // Si es edici贸n/renovaci贸n borrar el anterior
            if(clienteSel && clienteSel.nombre == n) await fetch(API_URL + "/id/" + clienteSel.id, { method: 'DELETE' });
            
            let tot = m + (m * (i/100));
            let nuevo = { id: Date.now().toString(), nombre: n, saldo: tot.toString(), total: tot.toString(), pagos: "[]", fecha_prestamo: fechaHoy(), posicion: p };
            
            await fetch(API_URL, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify([nuevo]) });
            cerrarModal('modalReg');
            clienteSel = null;
            cargarDatos();
        }

        function abrirMenu(id) {
            clienteSel = datosGlobales.find(x => x.id === id);
            document.getElementById('menu_nombre').innerText = clienteSel.nombre;
            abrirModal('modalMenu');
        }

        async function cobrar(id) {
            let a = prompt("Monto del abono:");
            if(!a || isNaN(a)) return;
            let cli = datosGlobales.find(x => x.id === id);
            let pgs = JSON.parse(cli.pagos || "[]");
            pgs.push({ pid: Date.now(), fecha: fechaHoy(), monto: parseFloat(a) });
            let ns = parseFloat(cli.saldo) - parseFloat(a);
            await fetch(API_URL + "/id/" + id, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ saldo: ns.toString(), pagos: JSON.stringify(pgs) }) });
            cargarDatos();
        }

        async function eliminarCli() { if(confirm("驴Eliminar cliente?")) { await fetch(API_URL + "/id/" + clienteSel.id, { method: 'DELETE' }); cerrarModal('modalMenu'); cargarDatos(); } }
        function verHis() {
            let pgs = JSON.parse(clienteSel.pagos || "[]");
            let h = pgs.map(p => `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span>${p.fecha}: <b>$${p.monto}</b></span></div>`).join('');
            document.getElementById('his_lista').innerHTML = h || "Sin pagos";
            cerrarModal('modalMenu'); abrirModal('modalHis');
        }
        function filtrar() {
            let b = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('#lista_c tr').forEach(tr => {
                tr.style.display = tr.getAttribute('data-nombre').includes(b) ? '' : 'none';
            });
        }
        function prepararRenovar() { document.getElementById('nom').value = clienteSel.nombre; document.getElementById('pos').value = clienteSel.posicion; cerrarModal('modalMenu'); abrirModal('modalReg'); }
        function actualizarBalance() {
            let ch=0, tc=0;
            datosGlobales.forEach(d => { tc += parseFloat(d.saldo) || 0; JSON.parse(d.pagos || "[]").forEach(pg => { if(pg.fecha === fechaHoy()) ch += pg.monto; }); });
            document.getElementById('c_hoy').innerText = "$" + ch.toFixed(2);
            document.getElementById('t_calle').innerText = "$" + tc.toFixed(2);
        }
    </script>
</body>
</html>
