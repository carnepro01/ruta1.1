<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta App Cloud</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; }
        .seccion { display: none; padding: 20px; }
        .activa { display: block; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); border-top: 1px solid #e2e8f0; }
        .nav-item { cursor: pointer; text-align: center; color: #64748b; font-size: 0.7rem; font-weight: bold; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 20px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 18px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; }
        .modal-content { background: white; width: 85%; max-width: 400px; margin: 15% auto; padding: 25px; border-radius: 15px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .loading { text-align: center; padding: 20px; color: #64748b; font-size: 0.9rem; }
    </style>
</head>
<body>

    <script>
        // PEGA AQU√ç TU URL DE SHEETSU
        const API_URL = "https://sheetdb.io/api/v1/851m8ra8nv7bu"; 
    </script>

    <div id="inicio" class="seccion activa">
        <h2 style="text-align:center">Panel de Ruta</h2>
        <button class="btn-main" onclick="abrirModal()">+ NUEVO PR√âSTAMO</button>
    </div>

    <div id="resumen" class="seccion">
        <h2>Contabilidad</h2>
        <div class="card"><span>EN CALLE</span><b id="c_calle">$0.00</b></div>
    </div>

    <div id="clientes" class="seccion">
        <h2>Mis Clientes</h2>
        <div id="loading" class="loading">Sincronizando...</div>
        <table><tbody id="lista_c"></tbody></table>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navegar('inicio', this)">üè†<br>Inicio</div>
        <div class="nav-item" onclick="navegar('resumen', this)">üìä<br>Caja</div>
        <div class="nav-item" onclick="navegar('clientes', this)">üë•<br>Ruta</div>
    </div>

    <div id="modalReg" class="modal">
        <div class="modal-content">
            <h3>Nuevo Pr√©stamo</h3>
            <input type="text" id="nom" placeholder="Nombre">
            <input type="number" id="mon" placeholder="Monto">
            <input type="number" id="int" placeholder="Inter√©s %">
            <button class="btn-main" id="btnGuardar" onclick="guardar()">GUARDAR EN NUBE</button>
            <button onclick="cerrarModal()" style="width:100%; background:none; border:none; color:red; margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <script>
        function navegar(id, el) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('activa');
            el.classList.add('active');
            if(id === 'clientes' || id === 'resumen') cargarDatos();
        }

        function abrirModal() { document.getElementById('modalReg').style.display = 'block'; }
        function cerrarModal() { document.getElementById('modalReg').style.display = 'none'; }

        async function guardar() {
            let n = document.getElementById('nom').value;
            let m = parseFloat(document.getElementById('mon').value);
            let i = parseFloat(document.getElementById('int').value) || 0;
            if(!n || isNaN(m)) return alert("Nombre y Monto son obligatorios");
            
            let btn = document.getElementById('btnGuardar');
            btn.innerText = "Enviando...";
            btn.disabled = true;

            let total = m + (m * (i/100));
            let nuevo = { id: Date.now().toString(), nombre: n, saldo: total.toString(), total: total.toString(), pagos: "[]" };

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify([nuevo])
                });
                if(res.ok) {
                    alert("¬°Guardado!");
                    cerrarModal();
                    document.getElementById('nom').value=''; document.getElementById('mon').value='';
                    navegar('clientes', document.querySelectorAll('.nav-item')[2]);
                } else {
                    alert("Error del servidor: " + res.status);
                }
            } catch (e) { alert("Error de conexi√≥n a la nube"); }
            btn.innerText = "GUARDAR EN NUBE";
            btn.disabled = false;
        }

        async function cargarDatos() {
            const loader = document.getElementById('loading');
            loader.style.display = 'block';
            loader.innerText = "Buscando datos...";

            try {
                const res = await fetch(API_URL, { method: 'GET', headers: { 'Accept': 'application/json' } });
                const datos = await res.json();
                
                if (Array.isArray(datos)) {
                    dibujar(datos);
                    loader.style.display = 'none';
                } else {
                    loader.innerText = "No hay datos en el Excel a√∫n.";
                }
            } catch (e) { 
                loader.innerText = "Error al cargar. Revisa tu URL de Sheetsu.";
                console.error(e);
            }
        }

        function dibujar(datos) {
            let lista = document.getElementById('lista_c'), enCalle = 0;
            lista.innerHTML = "";
            if(datos.length === 0) {
                document.getElementById('loading').innerText = "Lista vac√≠a.";
                document.getElementById('loading').style.display = 'block';
                return;
            }
            datos.forEach(d => {
                let s = parseFloat(d.saldo) || 0;
                enCalle += s;
                lista.innerHTML += `<tr>
                    <td><b>${d.nombre || 'Desconocido'}</b><br><small>Saldo: $${s.toFixed(2)}</small></td>
                    <td style="text-align:right">
                        ${s > 0 ? `<button onclick="cobrar('${d.id}', ${s})" style="background:var(--success); color:white; border:none; padding:10px 15px; border-radius:8px;">$</button>` : '‚úÖ'}
                    </td>
                </tr>`;
            });
            document.getElementById('c_calle').innerText = "$" + enCalle.toFixed(2);
        }

        async function cobrar(id, saldoActual) {
            let p = prompt("Monto del abono:");
            if(!p || isNaN(p)) return;
            let nuevoSaldo = saldoActual - parseFloat(p);
            
            try {
                await fetch(`${API_URL}/id/${id}`, {
                    method: 'PATCH',
                    headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' },
                    body: JSON.stringify({ saldo: nuevoSaldo.toString() })
                });
                cargarDatos();
            } catch (e) { alert("Error al cobrar"); }
        }
    </script>
</body>
</html>
