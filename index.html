<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta Cloud Pro</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f8fafc; --text: #1e293b; --danger: #ef4444; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding-bottom: 80px; color: var(--text); }
        .seccion { display: none; padding: 20px; }
        .activa { display: block; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #ddd; }
        .nav-item { cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #666; text-align: center; }
        .nav-item.active { color: var(--primary); }
        .card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        table { width: 100%; background: white; border-radius: 10px; border-collapse: collapse; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 100; }
        .modal-content { background: white; margin: 20% auto; padding: 20px; width: 80%; border-radius: 10px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
    </style>
</head>
<body>

    <script>
        // CAMBIA ESTO POR TU URL REAL DE SHEETSU
        const API_URL = "https://sheetdb.io/api/v1/851m8ra8nv7bu"; 
        let datosGlobales = [];
        const fechaHoy = () => new Date().toLocaleDateString();
    </script>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navegar('inicio', this)">üè†<br>Inicio</div>
        <div class="nav-item" onclick="navegar('resumen', this)">üìä<br>Caja</div>
        <div class="nav-item" onclick="navegar('clientes', this)">üë•<br>Lista</div>
    </div>

    <div id="inicio" class="seccion activa">
        <h2>Panel de Control</h2>
        <button class="btn-main" onclick="abrirModal()">+ NUEVO PR√âSTAMO</button>
    </div>

    <div id="resumen" class="seccion">
        <h2>Resumen de Hoy</h2>
        <div class="card">Cobrado: <b id="c_hoy">$0.00</b></div>
        <div class="card">Prestado: <b id="p_hoy">$0.00</b></div>
        <div class="card">Total Calle: <b id="t_calle">$0.00</b></div>
    </div>

    <div id="clientes" class="seccion">
        <h2>Clientes</h2>
        <div id="loading" style="display:none; text-align:center;">Cargando...</div>
        <table><tbody id="lista_c"></tbody></table>
    </div>

    <div id="modalReg" class="modal">
        <div class="modal-content">
            <h3>Registrar Cliente</h3>
            <input type="text" id="nom" placeholder="Nombre">
            <input type="number" id="mon" placeholder="Monto">
            <input type="number" id="int" placeholder="% Inter√©s">
            <button class="btn-main" onclick="guardar()">GUARDAR</button>
            <button onclick="cerrarModal()" style="width:100%; background:none; border:none; color:red; margin-top:10px;">Cerrar</button>
        </div>
    </div>

    <script>
        // Navegaci√≥n B√°sica
        function navegar(id, el) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('activa');
            el.classList.add('active');
            if(id !== 'inicio') cargarDatos();
        }

        function abrirModal() { document.getElementById('modalReg').style.display = 'block'; }
        function cerrarModal() { document.getElementById('modalReg').style.display = 'none'; }

        // Cargar Datos
        async function cargarDatos() {
            document.getElementById('loading').style.display = 'block';
            try {
                const response = await fetch(API_URL);
                const json = await response.json();
                datosGlobales = Array.isArray(json) ? json : [];
                dibujar();
                actualizarBalance();
            } catch (err) {
                alert("Error al conectar con la nube. Revisa la URL.");
            }
            document.getElementById('loading').style.display = 'none';
        }

        // Dibujar Tabla
        function dibujar() {
            const tbody = document.getElementById('lista_c');
            tbody.innerHTML = "";
            datosGlobales.forEach(d => {
                let s = parseFloat(d.saldo) || 0;
                tbody.innerHTML += `<tr>
                    <td><b>${d.nombre}</b><br><small>Saldo: $${s.toFixed(2)}</small></td>
                    <td align="right"><button onclick="cobrar('${d.id}')" style="background:#16a34a; color:white; border:none; padding:10px; border-radius:5px;">$</button></td>
                </tr>`;
            });
        }

        // Actualizar Balance
        function actualizarBalance() {
            let c = 0, p = 0, t = 0;
            datosGlobales.forEach(d => {
                t += parseFloat(d.saldo) || 0;
                if(d.fecha_prestamo === fechaHoy()) p += parseFloat(d.total) || 0;
                let pagos = JSON.parse(d.pagos || "[]");
                pagos.forEach(pago => { if(pago.fecha === fechaHoy()) c += pago.monto; });
            });
            document.getElementById('c_hoy').innerText = "$" + c.toFixed(2);
            document.getElementById('p_hoy').innerText = "$" + p.toFixed(2);
            document.getElementById('t_calle').innerText = "$" + t.toFixed(2);
        }

        // Guardar Nuevo
        async function guardar() {
            let n = document.getElementById('nom').value;
            let m = parseFloat(document.getElementById('mon').value);
            let i = parseFloat(document.getElementById('int').value) || 0;
            if(!n || !m) return alert("Llena los campos");

            let total = m + (m * (i/100));
            let nuevo = { 
                id: Date.now().toString(), 
                nombre: n, 
                saldo: total.toString(), 
                total: total.toString(), 
                pagos: "[]", 
                fecha_prestamo: fechaHoy() 
            };

            await fetch(API_URL, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify([nuevo])
            });
            cerrarModal();
            cargarDatos();
        }

        // Cobrar
        async function cobrar(id) {
            let abono = prompt("Monto del abono:");
            if(!abono || isNaN(abono)) return;
            
            let cli = datosGlobales.find(x => x.id === id);
            let pgs = JSON.parse(cli.pagos || "[]");
            pgs.push({ fecha: fechaHoy(), monto: parseFloat(abono) });
            let ns = parseFloat(cli.saldo) - parseFloat(abono);

            await fetch(API_URL + "/id/" + id, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ saldo: ns.toString(), pagos: JSON.stringify(pgs) })
            });
            cargarDatos();
        }
    </script>
</body>
</html>
