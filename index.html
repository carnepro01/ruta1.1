<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ruta Pro V3</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f1f5f9; --text: #1e293b; --danger: #ef4444; --warning: #f59e0b; --dark: #0f172a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding-bottom: 90px; color: var(--text); }
        
        /* BARRA DE NAVEGACI√ìN NEGRA (Para verificar actualizaci√≥n) */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: var(--dark); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); }
        .nav-item { cursor: pointer; font-size: 0.75rem; font-weight: bold; color: #94a3b8; text-align: center; transition: 0.2s; }
        .nav-item.active { color: #fff; transform: scale(1.1); }
        .nav-item span { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        .seccion { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .activa { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Tarjetas */
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        /* Lista */
        table { width: 100%; background: white; border-radius: 12px; border-collapse: separate; border-spacing: 0; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; }
        tr:last-child td { border-bottom: none; }
        .pagado { background: #ecfdf5; }
        .badge-pagado { background: #dcfce7; color: var(--success); font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; letter-spacing: 0.5px; border: 1px solid #bbf7d0; }
        .pos-num { background: var(--dark); color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.8rem; margin-right: 10px; font-weight: bold; }

        /* Botones e Inputs */
        .btn-main { background: var(--primary); color: white; border: none; width: 100%; padding: 16px; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 6px rgba(37, 99, 235, 0.3); }
        input { width: 100%; padding: 14px; margin: 10px 0; border: 2px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); background: white; }

        /* Botones del Men√∫ (Grandes y claros) */
        .btn-opt { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 10px; border: none; font-weight: 600; color: white; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: flex-start; text-align: left; }
        .btn-opt span { font-size: 1.5rem; margin-right: 15px; width: 30px; text-align: center; }

        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; backdrop-filter: blur(2px); }
        .modal-content { background: white; margin: 15vh auto; padding: 25px; width: 85%; max-width: 400px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .btn-del-pago { background: #fee2e2; color: #991b1b; border: none; padding: 6px 12px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-item active" onclick="navegar('inicio', this)"><span>üè†</span>Inicio</div>
        <div class="nav-item" onclick="navegar('resumen', this)"><span>üìä</span>Caja</div>
        <div class="nav-item" onclick="navegar('clientes', this)"><span>üë•</span>Lista</div>
    </div>

    <div id="inicio" class="seccion activa">
        <h2 style="text-align:center; color:var(--dark);">RUTA PRO V3</h2>
        <div class="card" style="text-align:center;">
            <p style="color:gray;">Bienvenido</p>
            <button class="btn-main" onclick="abrirModal('modalReg')">+ NUEVO PR√âSTAMO</button>
        </div>
    </div>

    <div id="resumen" class="seccion">
        <h2>Balance del D√≠a</h2>
        <div class="grid">
            <div class="card" style="border-top: 4px solid var(--success);">
                <span style="color:var(--success)">Cobrado Hoy</span>
                <b id="c_hoy" style="color:var(--dark); font-size:1.4rem;">$0</b>
            </div>
            <div class="card" style="border-top: 4px solid var(--danger);">
                <span style="color:var(--danger)">Prestado Hoy</span>
                <b id="p_hoy" style="color:var(--dark); font-size:1.4rem;">$0</b>
            </div>
        </div>
        <div class="card" style="border-top: 4px solid var(--primary);">
            <span>Capital Total en Calle</span>
            <b id="t_calle" style="color:var(--primary); font-size:1.6rem;">$0</b>
        </div>
    </div>

    <div id="clientes" class="seccion">
        <h2>Lista de Cobro</h2>
        <input type="text" id="buscador" placeholder="üîç Buscar cliente..." onkeyup="filtrar()">
        <div id="loading" style="display:none; text-align:center; padding:10px; color:var(--primary); font-weight:bold;">üîÑ Sincronizando con Google...</div>
        <table><tbody id="lista_c"></tbody></table>
    </div>

    <div id="modalReg" class="modal"><div class="modal-content">
        <h3 id="tituloReg" style="margin-top:0;">Nuevo Pr√©stamo</h3>
        <input type="text" id="nom" placeholder="Nombre completo">
        <input type="number" id="mon" placeholder="Monto ($)">
        <input type="number" id="int" placeholder="Inter√©s (%)" value="20">
        <input type="number" id="pos" placeholder="Posici√≥n en lista">
        <button id="btnGuardar" class="btn-main" onclick="guardar()">GUARDAR DATOS</button>
        <button onclick="cerrarModal('modalReg')" style="width:100%; padding:15px; background:none; border:none; color:var(--danger); font-weight:bold; margin-top:5px;">Cancelar</button>
    </div></div>

    <div id="modalMenu" class="modal"><div class="modal-content">
        <h3 id="menu_nombre" style="text-align:center; color:var(--dark); border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-top:0;">Cliente</h3>
        
        <button class="btn-opt" style="background:var(--primary);" onclick="verHis()">
            <span>üìú</span> Ver Historial / Pagos
        </button>
        
        <button class="btn-opt" style="background:#475569;" onclick="cambiarPos()">
            <span>1Ô∏è‚É£2Ô∏è‚É£</span> Cambiar Posici√≥n
        </button>
        
        <button class="btn-opt" style="background:var(--warning);" onclick="prepararRenovar()">
            <span>‚úèÔ∏è</span> Renovar / Editar
        </button>
        
        <button class="btn-opt" style="background:var(--danger);" onclick="eliminarCli()">
            <span>üóëÔ∏è</span> Eliminar Cliente
        </button>
        
        <button onclick="cerrarModal('modalMenu')" style="width:100%; padding:10px; background:none; border:none; color:gray; font-weight:bold;">Volver atr√°s</button>
    </div></div>

    <div id="modalHis" class="modal"><div class="modal-content">
        <h3>Historial de Pagos</h3>
        <div id="his_lista" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        <button class="btn-main" onclick="cerrarModal('modalHis')" style="background:#cbd5e1; color:#334155;">Cerrar</button>
    </div></div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyxGryUrPNGdVsTnNCc0hS3jiGJcQfJzcWjfgcSEwkGUyAouoVBxcFJnUym8shPAi5i/exec";
        let datosGlobales = [];
        let clienteSel = null;
        const fechaHoy = () => new Date().toLocaleDateString();

        function navegar(id, el) {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById(id).classList.add('activa');
            el.classList.add('active');
            if(id !== 'inicio') cargarDatos();
        }

        function abrirModal(id) { document.getElementById(id).style.display = 'block'; }
        function cerrarModal(id) { document.getElementById(id).style.display = 'none'; }

        async function cargarDatos() {
            document.getElementById('loading').style.display = 'block';
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                datosGlobales = Array.isArray(json) ? json : [];
                datosGlobales.sort((a, b) => (Number(a.posicion) || 999) - (Number(b.posicion) || 999));
                dibujar();
                actualizarBalance();
            } catch (e) { console.error(e); }
            document.getElementById('loading').style.display = 'none';
        }

        function actualizarBalance() {
            let ch=0, ph=0, tc=0;
            datosGlobales.forEach(d => {
                tc += parseFloat(d.saldo) || 0;
                if(d.fecha_prestamo === fechaHoy()) ph += parseFloat(d.total) || 0;
                let pgs = [];
                try { pgs = JSON.parse(d.pagos || "[]"); } catch(e) {}
                pgs.forEach(p => { if(p.fecha === fechaHoy()) ch += p.monto; });
            });
            document.getElementById('c_hoy').innerText = "$" + ch.toFixed(2);
            document.getElementById('p_hoy').innerText = "$" + ph.toFixed(2);
            document.getElementById('t_calle').innerText = "$" + tc.toFixed(2);
        }

        function dibujar() {
            const lista = document.getElementById('lista_c');
            lista.innerHTML = "";
            datosGlobales.forEach(d => {
                let pgs = [];
                try { pgs = JSON.parse(d.pagos || "[]"); } catch(e) {}
                let pagadoHoy = pgs.some(p => p.fecha === fechaHoy());
                lista.innerHTML += `<tr class="${pagadoHoy ? 'pagado' : ''}" data-nombre="${d.nombre.toLowerCase()}">
                    <td>
                        <div style="display:flex; align-items:center;">
                            <span class="pos-num">${d.posicion || '--'}</span>
                            <div onclick="abrirMenu('${d.id}')" style="cursor:pointer; flex-grow:1;">
                                <b style="color:var(--dark); font-size:1.1rem;">${d.nombre}</b>
                                ${pagadoHoy ? '<span class="badge-pagado">PAGADO</span>' : ''}
                                <div style="font-size:0.85rem; color:#64748b; margin-top:2px;">Saldo: $${parseFloat(d.saldo).toFixed(2)}</div>
                            </div>
                        </div>
                    </td>
                    <td align="right" style="vertical-align:middle;">
                        <button onclick="cobrar('${d.id}', event)" ${pagadoHoy ? 'disabled' : ''} style="background:${pagadoHoy ? '#cbd5e1' : 'var(--success)'}; color:white; border:none; width:50px; height:50px; border-radius:12px; font-size:1.5rem; box-shadow:0 2px 4px rgba(0,0,0,0.1); cursor:pointer;">$</button>
                    </td>
                </tr>`;
            });
        }

        // --- FUNCIONES DEL MEN√ö (L√ìGICA) ---
        function abrirMenu(id) { 
            clienteSel = datosGlobales.find(x => x.id == id); 
            document.getElementById('menu_nombre').innerText = clienteSel.nombre; 
            abrirModal('modalMenu'); 
        }

        async function eliminarCli() {
            if(!confirm("‚ö†Ô∏è ¬øEst√°s seguro de BORRAR a este cliente? Se perder√°n todos sus datos.")) return;
            cerrarModal('modalMenu');
            await enviarGoogle({ method: 'DELETE', id: clienteSel.id });
            setTimeout(cargarDatos, 1000);
        }

        async function cambiarPos() {
            let nPos = prompt("Nuevo n√∫mero de posici√≥n:", clienteSel.posicion);
            if(nPos === null) return;
            cerrarModal('modalMenu');
            await enviarGoogle({ method: 'PATCH', id: clienteSel.id, posicion: nPos });
            setTimeout(cargarDatos, 1000);
        }

        function prepararRenovar() { 
            document.getElementById('nom').value = clienteSel.nombre; 
            document.getElementById('pos').value = clienteSel.posicion; 
            document.getElementById('tituloReg').innerText = "Renovar Pr√©stamo";
            cerrarModal('modalMenu'); 
            abrirModal('modalReg'); 
        }

        function verHis() {
            let pgs = [];
            try { pgs = JSON.parse(clienteSel.pagos || "[]"); } catch(e) {}
            
            let html = "";
            if(pgs.length === 0) {
                html = "<div style='text-align:center; padding:20px; color:#94a3b8;'>No hay pagos registrados a√∫n.</div>";
            } else {
                html = pgs.map(p => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid #f1f5f9;">
                        <div>
                            <div style="font-weight:bold; color:#334155;">${p.fecha}</div>
                            <div style="color:var(--success); font-weight:bold;">+$${p.monto}</div>
                        </div>
                        <button class="btn-del-pago" onclick="eliminarPago('${p.pid}')">Eliminar</button>
                    </div>
                `).join('');
            }
            document.getElementById('his_lista').innerHTML = html;
            cerrarModal('modalMenu'); 
            abrirModal('modalHis');
        }

        async function eliminarPago(pid) {
            if(!confirm("¬øBorrar este pago y devolver el saldo?")) return;
            let pgs = JSON.parse(clienteSel.pagos || "[]");
            let pagoAEliminar = pgs.find(p => p.pid == pid);
            let nuevosPagos = pgs.filter(p => p.pid != pid);
            let nuevoSaldo = parseFloat(clienteSel.saldo) + parseFloat(pagoAEliminar.monto);

            await enviarGoogle({ method: 'PATCH', id: clienteSel.id, saldo: nuevoSaldo.toFixed(2), pagos: JSON.stringify(nuevosPagos) });
            cerrarModal('modalHis');
            setTimeout(cargarDatos, 1000);
        }

        // --- COBRO Y GUARDADO ---
        async function cobrar(id, event) {
            let a = prompt("Monto del abono:");
            if(!a || isNaN(a) || parseFloat(a) <= 0) return;
            const btn = event.target;
            btn.disabled = true;

            let cli = datosGlobales.find(x => x.id == id);
            let pgs = JSON.parse(cli.pagos || "[]");
            let monto = parseFloat(a);
            pgs.push({ pid: Date.now(), fecha: fechaHoy(), monto: monto });
            let ns = parseFloat(cli.saldo) - monto;

            await enviarGoogle({ method: 'PATCH', id: id, saldo: ns.toFixed(2), pagos: JSON.stringify(pgs) });
            setTimeout(cargarDatos, 800);
        }

        async function guardar() {
            const btn = document.getElementById('btnGuardar');
            let n = document.getElementById('nom').value, m = parseFloat(document.getElementById('mon').value),
                i = parseFloat(document.getElementById('int').value) || 0, p = document.getElementById('pos').value || "99";
            
            if(!n || !m) { alert("Faltan datos"); return; }
            btn.disabled = true;
            btn.innerText = "Guardando...";

            if(clienteSel && document.getElementById('tituloReg').innerText.includes("Renovar")) {
                 await enviarGoogle({ method: 'DELETE', id: clienteSel.id });
            }

            let tot = m + (m * (i/100));
            let nuevo = { method: 'POST', id: Date.now().toString(), nombre: n, saldo: tot.toFixed(2), total: tot.toFixed(2), pagos: "[]", fecha_prestamo: fechaHoy(), posicion: p };
            await enviarGoogle(nuevo);
            
            setTimeout(() => { 
                clienteSel = null;
                cerrarModal('modalReg'); 
                cargarDatos(); 
                btn.disabled = false;
                btn.innerText = "GUARDAR DATOS";
                document.getElementById('nom').value = "";
                document.getElementById('mon').value = "";
                document.getElementById('tituloReg').innerText = "Nuevo Pr√©stamo";
            }, 1000);
        }

        async function enviarGoogle(datos) {
            document.getElementById('loading').style.display = 'block';
            return fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(datos) });
        }

        function filtrar() {
            let b = document.getElementById('buscador').value.toLowerCase();
            document.querySelectorAll('#lista_c tr').forEach(tr => { 
                tr.style.display = tr.getAttribute('data-nombre').includes(b) ? '' : 'none'; 
            });
        }
    </script>
</body>
</html>
